#!/usr/bin/env bash
set -euo pipefail

# fallback in case DOTLOG isn't already set
DOTLOG="${DOTLOG:-$HOME/.dotfiles/bin/dotlog}"

if [[ -f "$DOTLOG" ]]; then
  source "$DOTLOG"
else
  echo "⚠️  DOTLOG not found at $DOTLOG. Continuing without logging functions."
fi

# constants
readonly GITHUB_URL="github.com"
readonly USERNAME="iamnewton"
readonly REPO="dotpackages"
readonly INSTALL_DIR="$HOME/.$REPO"
OS="$(tr '[:upper:]' '[:lower:]' <<<"$(uname)")"
readonly OS

seek_confirmation() {
	local message=$1

	dotlog::warning "$message"
	read -r -p "Continue? (y/n) " -n 1
}

is_confirmed() {
	if [[ "$REPLY" =~ ^[Yy]$ ]]; then
		return 0
	fi
	return 1
}

npm_package() {
	local package=$1

	# Test whether npm package is already installed
	dotlog::process "Checking if $package is installed"
	if ! npm list -g "$package" | grep "$package" &>/dev/null; then
		dotlog::process "Installing $package"
		npm install --global --quiet "$package"
	else
		dotlog::process "$package is already installed. Updating."
		npm update "$package"
	fi
}

whalebrew_package() {
	local package=$1

	dotlog::process "Checking if $package is installed"
	if ! whalebrew list | grep -q "$package"; then
		dotlog::process "Installing $package"
		whalebrew install "$package"
	else
		dotlog::process "$package is already installed."
	fi
}

install_packages() {
	local installer_func=$1
	local file=$2

	while IFS="" read -r p || [ -n "$p" ]; do
		# Skip blank lines or comments
		[[ -z "$p" || "$p" =~ ^# ]] && continue
		"$installer_func" "$p"
	done <"$file"
}

# Check for Homebrew; install brew
if ! type -P 'brew' &>/dev/null; then
	dotlog::process "Installing Homebrew"
	/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

	# If we're on Linux, insert brew into the path temporarily to be able to use later
	if [[ "$OS" == "linux" ]]; then
		dotlog::process "Sourcing Homebrew to PATH"
		eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
	fi

	[[ $? ]] && dotlog::success "Homebrew installed"
fi

# If missing, download and extract the dotpackages repository
# @TODO: create upgrade command
# dotlog::process "$REPO already installed.  Upgrading $REPO"
# dotpackages
if ! [[ -d "$INSTALL_DIR" ]]; then
	dotlog::warning "No $INSTALL_DIR found"

	dotlog::process "Creating directory at $INSTALL_DIR and setting permissions"
	mkdir -p "$INSTALL_DIR"

	dotlog::process "Downloading repository to /tmp directory"
	# (-#) shows the progress bar as # sign
	# (-f) fail silently
	# (-L) follow the headers
	# (-o) output to a file
	curl -#fLo /tmp/dotpackages.tar.gz "https://$GITHUB_URL/$USERNAME/$REPO/tarball/main"

	dotlog::process "Extracting files to $INSTALL_DIR"
	tar -zxf "/tmp/$REPO.tar.gz" --strip-components 1 -C "$INSTALL_DIR"

	dotlog::process "Removing tarball from /tmp directory"
	rm -rf "/tmp/$REPO.tar.gz"

	[[ $? ]] && dotlog::success "$INSTALL_DIR created, repository downloaded and extracted"
fi

if ! [[ -d "$INSTALL_DIR/.git" ]]; then
	# Change to the dotpackages directory
	cd "$INSTALL_DIR" || exit

	# Initialize the git repository if it's missing
	dotlog::process "Initializing git repository"
	git init

	dotlog::process "Setting main as the default branch"
	git branch -m main

	dotlog::process "Adding https://$GITHUB_URL/$USERNAME/$REPO.git as origin"
	git remote add origin "https://$GITHUB_URL/$USERNAME/$REPO.git"

	dotlog::process "Downloading changes from origin"
	git fetch origin main

	# Reset the index and working tree to the fetched HEAD
	# (submodules are cloned in the subsequent sync step)
	dotlog::process "Resetting index & working tree to fetched HEAD"
	git reset --hard FETCH_HEAD

	# Remove any untracked files
	dotlog::process "Removing any untracked files"
	git clean -fd

	[[ $? ]] && dotlog::success "Repository has been initialized"

	# Pull down the latest changes
	dotlog::process "Pulling down latest changes"
	git pull --rebase origin main

	[[ $? ]] && dotlog::success "Repository has been updated"
fi

# Install Homebrew formulae
if ! type -P 'brew' &>/dev/null; then
	dotlog::error "brew not found"
	exit 1
else
	dotlog::process "Installing Homebrew packages"

	brew update
	brew upgrade
	brew bundle --file="$INSTALL_DIR/opt/Brewfile"
	brew cleanup

	[[ $? ]] && dotlog::success "Installed all Homebrew packages"
fi

# Install Node packages
if ! type -P 'npm' &>/dev/null; then
	dotlog::error "npm not found"
	exit 1
else
	dotlog::process "Installing and updating npm packages"
	npm cache clean -f
	n stable
	install_packages npm_package "$INSTALL_DIR/opt/npm"

	[[ $? ]] && dotlog::success "Installed all Node packages"
fi

# Automatically set 1Password session after logging in
if [ -x "$(command -v op)" ]; then
	dotlog::process "Configuring 1Password CLI"
	printf "eval \$(op signin %s)\\n" "$USERNAME" >>"$HOME/.bash_profile.local"

	[[ $? ]] && dotlog::success "Configured 1Password CLI"
fi

if [ -x "$(command -v fzf)" ]; then
	dotlog::process "Installing FZF keybindings and fuzzy completion"
	dotlog::info "Do not say 'yes' to update the shell configuration, it's already set up"
	"$(brew --prefix)/opt/fzf/install"

	[[ $? ]] && dotlog::success "Installed FZF keybindings and fuzzy completion"
fi

# Install Gitmoji Fuzzy Hook
if ! type -P 'git' &>/dev/null; then
	dotlog::error "git not found"
	exit 1
else
	dotlog::process "Installing Gitmoji"
	git clone https://gitlab.com/raabf/gitmoji-fuzzy-hook.git "$HOME/.local/share/gitmoji-fuzzy-hook"
	[ -d "$HOME/.local/bin" ] || mkdir -p "$HOME/.local/bin"
	ln -sfn "$HOME/.local/share/gitmoji-fuzzy-hook/bin/gitmoji-fuzzy-hook-init.sh" "$HOME/.local/bin/gitmoji-fuzzy-hook-init"

	[[ $? ]] && dotlog::success "Installed Gitmoji"
fi

if [[ "$OS" == "darwin" ]]; then
	seek_confirmation "Do you want to install the MacOS apps?"
	if is_confirmed; then
		brew install mas
		brew bundle --file="$INSTALL_DIR/opt/Brewfile.macos"
		[[ $? ]] && dotlog::success "Installed all MacOS apps"
	fi
fi

# Install Whalebrew packages
if ! type -P 'whalebrew' &>/dev/null; then
	dotlog::error "whalebrew not found"
	exit 1
else
	dotlog::process "Installing and updating whalebrew packages"
	install_packages whalebrew_package "$INSTALL_DIR/opt/Brewfile.whale"

	[[ $? ]] && dotlog::success "Installed all Whalebrew packages"
fi

[[ $? ]] && dotlog::success "dotpackages installed."
